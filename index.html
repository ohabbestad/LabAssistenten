<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab-assistenten</title>

    <script src="https://kit.fontawesome.com/207e147084.js" crossorigin="anonymous"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="p-8">

    <div id="main-container" class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">
        Heihei Halloisann!

        <div id="loading-view" class="text-center p-12">
            <h1 class="text-3xl font-bold mb-4 text-gray-800">Lastar data...</h1>
            <div class="animate-pulse text-xl text-blue-500">Vent eitt lite augneblikk.</div>
        </div>

        <div id="heim-view" class="active-view">
            <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Velkommen til Lab-assistenten</h1>
            <p class="text-center text-lg mb-8 text-gray-600">Velg eit forsøk du vil starte:</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                <div id="syre-base-kort" class="bg-blue-100 p-6 rounded-lg shadow-md cursor-pointer hover:bg-blue-200 transition-colors duration-300">
                    <h2 class="text-xl font-semibold text-gray-800">Syre-base-titrering</h2>
                    <p class="mt-2 text-gray-600">Lær om nøytralisering og pH-verdi ved å utføre ei titrering.</p>
                </div>
                <div id="dansande-rosiner-kort" class="bg-blue-100 p-6 rounded-lg shadow-md cursor-pointer hover:bg-blue-200 transition-colors duration-300">
                    <h2 class="text-xl font-semibold text-gray-800">Dansande rosiner</h2>
                    <p class="mt-2 text-gray-600">Utforsk fenomenet med rosiner som dansar i kullsyre-vatn.</p>
                </div>
                
                <div id="papir-kort" class="bg-blue-100 p-6 rounded-lg shadow-md cursor-pointer hover:bg-blue-200 transition-colors duration-300">
                    <h2 class="text-xl font-semibold text-gray-800">Fargeseparasjon</h2>
                    <p class="mt-2 text-gray-600">Forstå korleis kromatografi kan brukast til å skille ulike fargestoff.</p>
                </div>
                <div id="magnet-kort" class="bg-blue-100 p-6 rounded-lg shadow-md cursor-pointer hover:bg-blue-200 transition-colors duration-300">
                    <h2 class="text-xl font-semibold text-gray-800">Lag ein Elektromagnet</h2>
                    <p class="mt-2 text-gray-600">Lær om samanhengen mellom elektrisitet og magnetisme.</p>
                </div>
                <div id="osmose-kort" class="bg-blue-100 p-6 rounded-lg shadow-md cursor-pointer hover:bg-blue-200 transition-colors duration-300">
                    <h2 class="text-xl font-semibold text-gray-800">Osmose med potet</h2>
                    <p class="mt-2 text-gray-600">Observer effekten av osmose (vanntransport) i planteceller.</p>
                </div>
                <div id="vulkan-kort" class="bg-blue-100 p-6 rounded-lg shadow-md cursor-pointer hover:bg-blue-200 transition-colors duration-300">
                    <h2 class="text-xl font-semibold text-gray-800">Kjemisk Vulkan</h2>
                    <p class="mt-2 text-gray-600">Demonstrer ein syre-base-reaksjon som produserer gass.</p>
                </div>
                </div>
        </div>

        <div id="oversikt-view" class="hidden">
            <h1 id="eksperiment-tittel" class="text-3xl font-bold mb-4 text-gray-800"></h1>
            
            <button id="les-opp-oversikt-btn" class="my-3 bg-blue-500 text-white font-semibold py-2 px-4 rounded-md shadow-lg hover:bg-blue-600 transition-colors duration-300">
                <i class="fa-brands fa-readme"></i> Les opp tekst
            </button>

            <img id="eksperiment-bilde" class="w-full max-w-md mx-auto rounded-lg shadow-md mb-6" src="" alt="Eksperimentbilde">

            <p id="eksperiment-skildring" class="text-lg text-gray-600 mb-6"></p>
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Utstyr</h2>
            <ul id="utstyrsliste" class="list-disc list-inside space-y-1 text-gray-700"></ul>

            <h2 class="text-2xl font-semibold mt-8 mb-4 text-gray-800">Mål</h2>
            <ul id="maal-liste" class="list-disc list-inside space-y-1 text-gray-700"></ul>

            <button id="heim-btn" class="mt-8 bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md shadow-lg hover:bg-gray-500 transition-colors duration-300">
                <i class="fa-solid fa-arrow-left"></i> Tilbake
            </button>
            <button id="start-eksperiment-btn" class="mt-8 ml-4 bg-blue-600 text-white font-semibold py-2 px-6 rounded-md shadow-lg hover:bg-blue-700 transition-colors duration-300">
                <i class="fa-regular fa-circle-play"></i> Start forsøket
            </button>
        </div>

        <div id="steg-view" class="hidden">
            <div id="step-content" class="mb-6">
                <h2 id="step-tittel" class="text-2xl font-semibold mb-2 text-gray-800"></h2>
                
                <button id="les-opp-btn" class="my-3 bg-blue-500 text-white font-semibold py-2 px-4 rounded-md shadow-lg hover:bg-blue-600 transition-colors duration-300">
                    <i class="fa-brands fa-readme"></i> Les opp tekst
                </button>

                <p id="step-text" class="text-lg text-gray-700 mb-4"></p>
                
                
                
                <div id="step-media" class="mb-4"></div>
                
                <div id="step-question-container" class="mt-6 p-4 border border-gray-300 rounded-md bg-gray-50">
                    <p id="step-question" class="font-medium text-gray-800 mb-2"></p>
                    <textarea id="steg-svar" class="w-full h-24 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
            <div class="flex">
                <div class="w-1/2 text-left">
                    <button id="forrige-steg-btn" class="bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow-lg hover:bg-gray-500 transition-colors duration-300">
                        <i class="fa-solid fa-arrow-left"></i> Forrige
                    </button>
                </div>
                <div class="w-1/2 text-right">
                    <button id="neste-steg-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-lg hover:bg-blue-700 transition-colors duration-300">
                        <i class="fa-solid fa-arrow-right"></i> Neste
                    </button>
                </div>
            </div>

            
            <div class="text-center mt-6">
                <button id="steg-til-heim-btn" class="bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow-lg hover:bg-gray-500 transition-colors duration-300">
                    <i class="fa-regular fa-house"></i> Avbryt og gå til startsida
                </button>
            </div>

        </div>

        <div id="rapport-view" class="hidden">
            <h1 class="text-3xl font-bold mb-4 text-gray-800">Lab-rapport</h1>

            <p class="text-gray-600 mb-6">Her er svara dine. Du kan kopiere teksten og bruke den som utgangspunkt for rapporten din.</p>
            
            <button id="les-opp-rapport-btn" class="my-3 bg-blue-500 text-white font-semibold py-2 px-4 rounded-md shadow-lg hover:bg-blue-600 transition-colors duration-300">
                <i class="fa-brands fa-readme"></i> Les opp rapport
            </button>
            
            <div id="rapport-text-container" class="bg-gray-100 p-6 rounded-lg shadow-inner">
                <pre id="rapport-text" class="whitespace-pre-wrap text-gray-800 font-mono text-sm"></pre>
            </div>

            <button id="rapport-til-steg-btn" class="bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow-lg hover:bg-gray-500 transition-colors duration-300">
                <i class="fa-solid fa-arrow-left"></i> Forrige
            </button>
            <button id="kopier-rapport-btn" class="mt-6 bg-green-600 text-white font-semibold py-2 px-6 rounded-md shadow-lg hover:bg-green-700 transition-colors duration-300">
                <i class="fa-regular fa-copy"></i> Kopier rapport
            </button>

            <div class="text-center mt-6">
                <button id="rapport-til-heim-btn" class="bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow-lg hover:bg-gray-500 transition-colors duration-300">
                    <i class="fa-regular fa-house"></i> Avbryt og gå til startsida
                </button>
            </div>
        </div>

    </div>

    <script>
        let eksperiment = {};
        
        const loadingView = document.getElementById('loading-view');
        const homeView = document.getElementById('heim-view');
        const oversiktView = document.getElementById('oversikt-view');
        const stegView = document.getElementById('steg-view');
        const rapportView = document.getElementById('rapport-view');
        
        function showView(viewToShow) {
                window.speechSynthesis.cancel();
                const views = [loadingView, homeView, oversiktView, stegView, rapportView];
                views.forEach(view => view.classList.add('hidden'));
                viewToShow.classList.remove('hidden');
        }

        document.addEventListener ('DOMContentLoaded', () => { 
            
            showView(loadingView);

            fetch('eksperiment.json')
            .then(response => response.json())
            .then(data => {
                eksperiment = data;
                initializeApp();
            })
            .catch(error => {
                console.error('Klarte ikkje å laste eksperiment:', error);
            });
        });

        function initializeApp() {

            const startEksperimentBtn = document.getElementById('start-eksperiment-btn');
            const heimBtn = document.getElementById('heim-btn');
            const forrigeStegBtn = document.getElementById('forrige-steg-btn');
            const nesteStegBtn = document.getElementById('neste-steg-btn');
            const stegSvarInput = document.getElementById('steg-svar');
            const kopierRapportBtn = document.getElementById('kopier-rapport-btn');
            const rapportText = document.getElementById('rapport-text');

            const stegTilHeimBtn = document.getElementById('steg-til-heim-btn');
            const lesOppBtn = document.getElementById('les-opp-btn');
            const lesOppOversiktBtn = document.getElementById('les-opp-oversikt-btn');
            const lesRapportBtn = document.getElementById('les-opp-rapport-btn');
            const rapportTilStegBtn = document.getElementById('rapport-til-steg-btn');
            const rapportTilHeimBtn = document.getElementById('rapport-til-heim-btn');


            let aktueltEksperiment = null;
            let aktueltStegIndex = 0;

            // --- localStorage-funksjonar (Oppdatert) ---
            function saveAnswersToLocalStorage() {
                // Hentar alle nøklar frå eksperiment-objektet dynamisk
                const eksperimentKeys = Object.keys(eksperiment);
                const lagraSvar = {};
                
                eksperimentKeys.forEach(key => {
                    if (eksperiment[key] && eksperiment[key].steg) {
                        lagraSvar[key] = eksperiment[key].steg.map(step => step.answer);
                    }
                });
                
                localStorage.setItem('labAssistentSvar', JSON.stringify(lagraSvar));
            }

            function loadAnswersFromLocalStorage() {
                const savedAnswers = JSON.parse(localStorage.getItem('labAssistentSvar'));
                if (savedAnswers) {
                    // Lastar alt som finst i localStorage
                    const eksperimentKeys = Object.keys(eksperiment);
                    eksperimentKeys.forEach(key => {
                        if (savedAnswers[key] && eksperiment[key] && eksperiment[key].steg) {
                            eksperiment[key].steg.forEach((step, index) => {
                                step.answer = savedAnswers[key][index] || "";
                            });
                        }
                    });
                }
            }
            
            loadAnswersFromLocalStorage();
            // --- localStorage-funksjonar slutt ---


            // Funksjonar for å bytte visning
            

            function loadExperimentOverview(experimentKey) {
                aktueltEksperiment = eksperiment[experimentKey];
                if (!aktueltEksperiment) return;

                document.getElementById('eksperiment-tittel').textContent = aktueltEksperiment.tittel;
                document.getElementById('eksperiment-bilde').src = aktueltEksperiment.foto;
                document.getElementById('eksperiment-skildring').textContent = aktueltEksperiment.skildring;

                const utstyrList = document.getElementById('utstyrsliste');
                utstyrList.innerHTML = '';
                aktueltEksperiment.utstyr.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    utstyrList.appendChild(li);
                });

                const goalList = document.getElementById('maal-liste');
                goalList.innerHTML = '';
                aktueltEksperiment.maal.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    goalList.appendChild(li);
                });

                showView(oversiktView);
            }

            function loadStep(index) {
                const step = aktueltEksperiment.steg[index];
                if (!step) return;

                document.getElementById('step-tittel').textContent = step.tittel;
                document.getElementById('step-text').textContent = step.tekst;
                document.getElementById('step-question').textContent = step.question;

                const mediaContainer = document.getElementById('step-media');
                mediaContainer.innerHTML = ''; 

                if (step.bilde) {
                    const img = document.createElement('img');
                    img.src = step.bilde;
                    img.alt = step.tittel;
                    img.className = "w-full max-w-md mx-auto rounded-lg shadow-md mb-4"; 
                    mediaContainer.appendChild(img);
                }
                
                stegSvarInput.value = step.answer || '';
                stegSvarInput.focus();
                
                forrigeStegBtn.classList.toggle('hidden', index === 0);
                if (index === aktueltEksperiment.steg.length - 1) {
                    nesteStegBtn.innerHTML = '<i class="fa-solid fa-marker"></i> Generer rapport';
                } else {
                    nesteStegBtn.innerHTML = 'Neste <i class="fa-solid fa-arrow-right"></i>';
                }

                showView(stegView);
            }

            function genererRapport() {
                let reportContent = `Lab-rapport: ${aktueltEksperiment.tittel}\n\n`;
                reportContent += `Mål:\n`;
                aktueltEksperiment.maal.forEach(goal => {
                    reportContent += `- ${goal}\n`;
                });
                reportContent += `\nUtstyr:\n`;
                aktueltEksperiment.utstyr.forEach(item => {
                    reportContent += `- ${item}\n`;
                });
                reportContent += `\nGjennomføring og resultater:\n`;

                aktueltEksperiment.steg.forEach(step => {
                    reportContent += `\n${step.tittel}\n`;
                    reportContent += `Spørsmål: ${step.question}\n`;
                    reportContent += `Svar: ${step.answer}\n`;
                });

                rapportText.textContent = reportContent;
                showView(rapportView);
            }

            // Event listeners
            document.getElementById('syre-base-kort').addEventListener('click', () => {
                loadExperimentOverview("syre-base-titrering");
            });

            document.getElementById('dansande-rosiner-kort').addEventListener('click', () => {
                loadExperimentOverview("dansande-rosiner");
            });

            document.getElementById('papir-kort').addEventListener('click', () => {
                loadExperimentOverview("papirkromatografi");
            });
            
            document.getElementById('magnet-kort').addEventListener('click', () => {
                loadExperimentOverview("elektromagnet");
            });

            document.getElementById('osmose-kort').addEventListener('click', () => {
                loadExperimentOverview("osmose");
            });

            document.getElementById('vulkan-kort').addEventListener('click', () => {
                loadExperimentOverview("vulkan");
            });

            startEksperimentBtn.addEventListener('click', () => {
                aktueltStegIndex = 0;
                loadStep(aktueltStegIndex);
            });

            heimBtn.addEventListener('click', () => {
                showView(homeView);
            });

            forrigeStegBtn.addEventListener('click', () => {
                aktueltEksperiment.steg[aktueltStegIndex].answer = stegSvarInput.value;
                saveAnswersToLocalStorage();

                aktueltStegIndex--;
                loadStep(aktueltStegIndex);
                
            });

            nesteStegBtn.addEventListener('click', () => {
                aktueltEksperiment.steg[aktueltStegIndex].answer = stegSvarInput.value;
                saveAnswersToLocalStorage(); 

                if (aktueltStegIndex < aktueltEksperiment.steg.length - 1) {
                    aktueltStegIndex++;
                    loadStep(aktueltStegIndex);
                } else {
                    genererRapport();
                }
            });

            kopierRapportBtn.addEventListener('click', () => {
                const range = document.createRange();
                range.selectNodeContents(rapportText);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                try {
                    document.execCommand('copy');
                    alert('Rapporten er kopiert til utklippstavlen!');
                } catch (err) {
                    console.error('Kunne ikke kopiere tekst: ', err);
                }
                selection.removeAllRanges();
            });

            stegTilHeimBtn.addEventListener('click', () => {
                showView(homeView);
            });

            lesOppBtn.addEventListener('click', () => {
                const tittel = document.getElementById('step-tittel').textContent;
                const text = document.getElementById('step-text').textContent;
                const question = document.getElementById('step-question').textContent;
                
                const textToRead = `${tittel}. ${text}. Spørsmål: ${question}`;

                window.speechSynthesis.cancel(); 
                
                const utterance = new SpeechSynthesisUtterance(textToRead);
                utterance.lang = 'nb-NO';
                window.speechSynthesis.speak(utterance);
            });

            lesOppOversiktBtn.addEventListener('click', () => {
                const tittel = aktueltEksperiment.tittel;
                const text = aktueltEksperiment.skildring;
                const utstyr = aktueltEksperiment.utstyr.join(', ');
                const maal = aktueltEksperiment.maal.join(', ');
                
                const textToRead = `${tittel}. ${text}. Utstyr: ${utstyr}. Mål: ${maal}.`;

                window.speechSynthesis.cancel(); 
                
                const utterance = new SpeechSynthesisUtterance(textToRead);
                utterance.lang = 'nb-NO';
                window.speechSynthesis.speak(utterance);
            });
            
            lesRapportBtn.addEventListener('click', () => {
                const reportContent = rapportText.textContent;
                
                window.speechSynthesis.cancel(); 
                
                const utterance = new SpeechSynthesisUtterance(reportContent);
                utterance.lang = 'nb-NO';
                window.speechSynthesis.speak(utterance);
            });

            rapportTilStegBtn.addEventListener('click', () => {
                loadStep(aktueltStegIndex);
            });

            rapportTilHeimBtn.addEventListener('click', () => {
                showView(homeView);
            });
            

            window.addEventListener('beforeunload', () => {
                localStorage.removeItem('labAssistentSvar');
            });
            showView(homeView);
        };
    </script>
</body>
</html>